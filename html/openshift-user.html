<!DOCTYPE html>
<!--- regex replacemant for command prompt:
[0-9][0-9]:.*mleimenmeier.*+:[A-Za-z~]*+> -> <strong>\&</strong>
[0-9][0-9]:.*leimm.*+:[A-Za-z~]*+> -> <strong>\&</strong>
--->

<html>
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type">
    <title>OpenShift f&uuml;r Benutzer / Entwickler</title>
    <link rel="stylesheet" type="text/css" href="standard.css" />
  </head>
  <body>
    <div id="contents">

      <div id="header">
	<img src="images/header.png" alt="Site Header">
      </div> <!-- header -->

<nav>
	<ul>
	  <li><a href="index.html">HOME</a></li>
	  <li><a href="openshift-general.html">OpenShift Allgemein</a></li>
	  <li class="selected"><a href="openshift-user.html">OpenShift f&uuml;r Benutzer</a></li>
	  <li><a href="openshift-admin.html">OpenShift f&uuml;r Administratoren</a></li>
		<li><a href="impressum.html">IMPRESSUM</a></li>
	</ul>
</nav>

<div id="maincontents">
	<a name="top"/>
	<h1>OpenShift f&uuml;r Benutzer / Entwickler</h1>
	<div id="OpenShift">
	  <p>Diese Anleitung soll dabei helfen die g&auml;ngigsten Arbeitsschritte des Admins eines OpenShift Clusters zu erl&auml;utern.</p>

		<!-- <div id="toc" class="sidenav">
			<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
			<ol>
				<li><a href="#architecture"><h7>Architektur</h7></a></li>
				<ol>
					<li><a href="#objekte"><h8>Objekte im OpenShift</h8></a></li>
				</ol>
				<li><a href="#login"><h7>Anmelden am Openshift Cluster</h7></a></li>
				<li><a href="#new-project"><h7>Projekt erstellen</h7></a></li>
				<li><a href="#new-app"><h7>Applikation erstellen</h7></a></li>
				<ol>
					<li><a href="#new-app-template"><h8>Installation einer MongoDB via Template</h8></a></li>
					<li><a href="#new-app-s2i"><h8>Installation einer Python Applikation via S2I Builder Image</h8></a></li>
					<li><a href="#new-app-dockerfile"><h8>Installation einer Applikation via Docker Build Strategie</h8></a></li>
				</ol>
				<li><a href="#ssh-keys"><h7>SSH Schl&uuml;ssel hinterlegen</h7></a></li>
				<li><a href="#webhooks"><h7>Webhooks konfigurieren</h7></a></li>
			</ol>
		</div> -->

		<span onclick="openNav()">Inhaltsverzeichnis</span>

	  <a name="new-project"/>
	  <h2>Projekt erstellen</h2>
	  <p>Ist man noch keinem Projekt zugeteilt sollte man sich zuerst ein Projekt erstellen, da dies gleichzeitig auch den aktuellen Arbeitsbereich darstellt:</p>
	  <ol>
	    <li>
	      <code><pre>oc new-project &lt;Projektkennung&gt; [--display-name="Bezeichnung"] [â€“description="Ausf&uuml;hrliche Beschreibung"]</pre></code>
	    </li>
	  </ol>
	  <p>
	    <code><pre><strong>09:23:57 leimm@189tuxlem001:~></strong> oc new-project mongodbdemo --display-name="MongoDB Demo App" --description="Eine kleines Songarchiv um die Funktion einer Mongo Datenbank mit persistentem Storage innerhalb des OpenShift Clusters zu demonstrieren."
Now using project "mongodbdemo" on server "https://openshift-nonprod.gfi.ihk.de:8443".

You can add applications to this project with the 'new-app' command. For example, try:

    $ oc new-app centos/ruby-22-centos7~https://github.com/openshift/ruby-hello-world.git

to build a new hello-world application in Ruby.</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_NewProject.png" alt="Neues Projekt mit der WebGUI anlegen" />
	  </p>


	  <p><a href="#top">Back to top</a></p>
	  <div class="page-break"></div>


	  <a name="new-app"/>
	  <h2>Applikation erstellen</h2>
	  <p>Innerhalb eines Projektes kann es mehre Applikationen geben. Eine Applikation besteht wiederum mindestens aus einer DeploymentConfig und einem ImageStream f&uuml;r das fertige Docker Image; zumeist aber auch einer BuildConfig und einem weiteren ImageStream f&uuml;r das Docker Image, welches als Basisimage angegeben wurde.</p>
	  <ol>
	    <li>Zu allererst m&uuml;ssen die eigenen Quellcodes bzw. bei einem Docker Build das entsprechende Dockerfile in einem vom OpenShift erreichbaren git Repository abgelegt sein.</li>
	    <li>Ist das Repository zum klonen nicht &ouml;ffentlich zug&auml;nglich muss eine Authentifizierung via ssh key eingerichtet werden (siehe HowTo: Repository Authentifizierung einrichten)</li>
	    <li>Zur Erstellung einer Applikation gibt es im OpenShift drei verschiedene M&ouml;glichkeiten:<ol>
		<li>
		  <strong>Source2Image (S2I)</strong>: Hierbei nutze ich ein meist von RedHat bereitgestelltes BuilderImage welches dahingehend optimiert wurde, dass man nur noch die url des Quellcode Repositories angeben muss, evtl. Modulabh&auml;ngigkeiten in einer entsprechenden Datei (bei Python z.B. die requirements.txt) hinterlegt und bei Bedarf noch weitere Konfigurationsparameter angeben kann. Bei der Einrichtung der MongoDB unten handelt es sich zum Beispiel um die Anwendung des S2I Verfahrens.</li>
		<li>
		  <strong>Docker Build</strong>: Bei dieser Strategie legt man ein <em>Dockerfile</em> mit den f&uuml;r den Build notwendigen Informationen, sowie gegebenenfalls n&ouml;tigen weiteren Dateien (Konfigurationsdateien, Daten usw.) und evtl. vorhandenen Quellcodes in einem git repository ab und gibt dies bei der Erstellung der App mit an. Alle notwendigen Konfigurationsparameter stehen im <em>Dockerfile</em> oder werden als Environment Variablen entweder bei der Erstellung auf der Kommandozeile oder auch nachtr&auml;glich durch hinzuf&uuml;gen in der DeploymentConfig gesetzt. Ein erstellen der App mit dieser Build Strategie ist ausschliesslich &uuml;ber die Kommandozeile m&ouml;glich. Ein Beispiel findet man unten f&uuml;r die "songbase" Webapplikation.</li>
		<li>
		  <strong>Custom Build</strong>: Ben&ouml;tigt man &uuml;ber diese beiden Verfahren hinaus noch weitere M&ouml;glichkeiten den Buildprozess zu steuern gibt es auch noch die M&ouml;glichkeit eigene Templates zu definieren oder z.B. den integrierten Jenkins CI Server zu nutzen. Eine Vorstellung all dieser M&ouml;glichkeiten w&uuml;rde aber den Rahmen dieses HowTos sprengen und wird daher an anderer Stelle behandelt.</li>
	      </ol>
	    </li>
	  </ol>
	  


	  <a name="new-app-template"/>
	  <h3>Installation einer MongoDB via Template (S2I Builder Image analog)</h3>
	  <h4>Schauen welche Ressourcen via "Add to Project..." erh&auml;ltlich sind</h4>
	  <p>
	    <code><pre><strong>10:08:20 leimm@189tuxlem001:~></strong> oc new-app --search mongodb
Templates (oc new-app --template=&lt;template&gt;)
-----
mongodb-ephemeral
  Project: openshift
  MongoDB database service, without persistent storage. WARNING: Any data stored will be lost upon pod destruction. Only use this template for testing
mongodb-persistent
  Project: openshift
  MongoDB database service, with persistent storage. Scaling to more than one replica is not supported
nodejs-mongodb-example
  Project: openshift
  An example Node.js application with a MongoDB database
Image streams (oc new-app --image-stream=&lt;image-stream&gt; [--code=&lt;source&gt;])
-----
mongodb
  Project: openshift
  Tags:    2.4, 2.6, latest</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_AddToProject.png" alt="Eine Ressource oder Applikation zum Projekt hinzuf&uuml;gen"/>
	  </p>
	  
	  <h4>Mongo Datenbank mit 512MB grossem persistentem Storage hinzuf&uuml;gen</h4>
	  <p>
	    <code><pre><strong>10:42:03 leimm@189tuxlem001:~></strong> oc new-app --param MONGODB_DATABASE=songdb,MONGODB_USER=river,MONGODB_PASSWORD=song,MONGODB_ADMIN_PASSWORD=tardis --name=songdb --template=mongodb-persistent
--> Deploying template "mongodb-persistent" in project "openshift" for "mongodb-persistent"
     With parameters:
      DATABASE_SERVICE_NAME=mongodb
      MONGODB_USER=river
      MONGODB_PASSWORD=song
      MONGODB_DATABASE=songdb
      MONGODB_ADMIN_PASSWORD=tardis
      VOLUME_CAPACITY=512Mi
--> Creating resources with label app=songdb ...
    service "mongodb" created
    persistentvolumeclaim "mongodb" created
    deploymentconfig "mongodb" created
--> Success
      Run 'oc status' to view your app.</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_AddMongoDB.png" alt="Eine Mongo Datenbank zum Projekt hinzuf&uuml;gen."/>
	  </p>
	  <h4>&Uuml;bersicht &uuml;ber das aktuelle Projekt anzeigen</h4>
	  
	  <p>
	    <code><pre><strong>10:42:18 leimm@189tuxlem001:~></strong> oc status -v
In project MongoDB Demo App (mongodbdemo) on server https://openshift-nonprod.gfi.ihk.de:8443

svc/mongodb - 172.30.8.138:27017
  dc/mongodb deploys openshift/mongodb:latest
    deployment #1 running for about a minute - 1 pod

Warnings:
  * dc/mongodb has no readiness probe to verify pods are ready to accept traffic or ensure deployment is successful.
    try: oc set probe dc/mongodb --readiness ...

View details with 'oc describe &lt;resource&gt;/&lt;name&gt;' or list everything with 'oc get all'.</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_MongoDB_Overview.png" alt="&Uuml;bersicht &uuml;ber das Projekt mit einer MongoDB Instanz." />
	  </p>
	  <h4>Wie im Warning oben gew&uuml;nscht eine "Readiness"-Probe f&uuml;r den Dienst hinzuf&uuml;gen</h4>
	  
	  <p>
	    <code><pre><strong>10:17:44 leimm@189tuxlem001:~></strong> oc set probe dc/mongodb --readiness --open-tcp=27017
	      deploymentconfig "mongodb" updated</pre></code>
	  </p>


	  <p><a href="#top">Back to top</a></p>

	  
	  <a name="new-app-s2i"/>
	  <h3>Installation einer Python Applikation via S2I Builder Image</h3>
	  <h4>Schauen welche Ressourcen via "Add to Project..." erh&auml;ltlich sind</h4>
	  <p>
	    <code><pre><strong>10:08:20 leimm@189tuxlem001:~></strong> oc new-app --search python
Image streams (oc new-app --image-stream=&lt;image-stream&gt; [--code=&lt;source&gt;])
-----
python
  Project: openshift
  Tags:    2.7, 3.3, 3.4, latest

Docker images (oc new-app --docker-image=&lt;docker-image&gt; [--code=&lt;source&gt;])
-----
python
  Registry: Docker Hub
  Tags:     latest</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_AddToProject_Python.png" alt="Eine Python Applikation ausw&auml;len."/>
	  </p>


	  <h4>Python 2.7 Applikation mit Hilfe der &lt;image&gt;:&lt;version&gt;~&lt;gitrepo&gt; Syntax erzeugen</h4>
	  <p>
	    <code><pre><strong>14:48:17 leimm@189tuxlem001:~></strong> oc new-app --name=songbase openshift/python:2.7~ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git
--> Found image 1ad8f28 (4 months old) in image stream "python" in project "openshift" under tag "2.7" for "openshift/python:2.7"

    Python 2.7
    ----------
    Platform for building and running Python 2.7 applications

    Tags: builder, python, python27, rh-python27

    * A source build using source code from ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git will be created
      * The resulting image will be pushed to image stream "songbase:latest"
    * This image will be deployed in deployment config "songbase"
    * Port 8080/tcp will be load balanced by service "songbase"
      * Other containers can access this service through the hostname "songbase"

--> Creating resources with label app=songbase ...
    imagestream "songbase" created
    buildconfig "songbase" created
    deploymentconfig "songbase" created
    service "songbase" created
--> Success
    Build scheduled for "songbase", use 'oc logs' to track its progress.
    Run 'oc status' to view your app.</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_AddPythonApp.png" alt="Parameter f&uuml;r eine Python 2.7 Applikation"/>
	  </p>


	  <h4>Build Vorgang starten und beobachten</h4>
	  <p>
	    entweder mit
	    <code><pre><strong>15:03:35 leimm@189tuxlem001:~></strong> oc start-build bc/songbase
songbase-4

<strong>15:03:58 leimm@189tuxlem001:~></strong> oc logs bc/songbase
I0601 13:43:13.562766       1 builder.go:57] Master version "v1.1.3", Builder versions "v1.1.3"
I0601 13:43:13.578552       1 builder.go:145] Running build with cgroup limits: api.CGroupLimits{MemoryLimitBytes:9223372036854775807, CPUShares:2, CPUPeriod:100000, CPUQuota:-1, MemorySwap:9223372036854775807}
I0601 13:43:13.581236       1 sti.go:190] The value of ALLOWED_UIDS is [1-]
I0601 13:43:14.009030       1 docker.go:290] Using locally available image "docker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a"
I0601 13:43:14.062637       1 sti.go:212] Creating a new S2I builder with build config: "Builder Name:\t\tPython 2.7\nBuilder Image:\t\tdocker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a\nBuilder Image Version:\t738d0f859cfd2a80bb11e48eeefb3a6eb1b3c4f3\nBuilder Base Version:\t8d95148\nSource:\t\t\tfile:///tmp/s2i-build284983461/upload/src\nOutput Image Tag:\tpodenv/songbase-4:dddeb478\nEnvironment:\t\tOPENSHIFT_BUILD_NAME=songbase-4,OPENSHIFT_BUILD_NAMESPACE=podenv,OPENSHIFT_BUILD_SOURCE=ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git\nIncremental Build:\tdisabled\nRemove Old Build:\tdisabled\nBuilder Pull Policy:\tif-not-present\nQuiet:\t\t\tdisabled\nLayered Build:\t\tdisabled\nWorkdir:\t\t/tmp/s2i-build284983461\nDocker NetworkMode:\tcontainer:5143741f587c6a0c514df19418240accb41dedbc8e1c063a6e62d03487268081\nDocker Endpoint:\tunix:///var/run/docker.sock\n"
I0601 13:43:14.088658       1 docker.go:290] Using locally available image "docker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a"
I0601 13:43:14.141760       1 docker.go:290] Using locally available image "docker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a"
I0601 13:43:14.141813       1 docker.go:410] Image contains io.openshift.s2i.scripts-url set to 'image:///usr/libexec/s2i'
I0601 13:43:14.141909       1 sti.go:140] Preparing to build podenv/songbase-4:dddeb478
I0601 13:43:14.147985       1 source.go:197] Downloading "ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git" ...
I0601 13:43:14.364602       1 source.go:208] Cloning source from ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git
I0601 13:43:14.596791       1 install.go:236] Using "assemble" installed from "image:///usr/libexec/s2i/assemble"
I0601 13:43:14.596854       1 install.go:236] Using "run" installed from "image:///usr/libexec/s2i/run"
I0601 13:43:14.596875       1 install.go:236] Using "save-artifacts" installed from "image:///usr/libexec/s2i/save-artifacts"
I0601 13:43:14.596916       1 sti.go:148] Clean build will be performed
I0601 13:43:14.596922       1 sti.go:151] Performing source build from file:///tmp/s2i-build284983461/upload/src
I0601 13:43:14.596929       1 sti.go:164] Running "assemble" in "podenv/songbase-4:dddeb478"
I0601 13:43:14.596952       1 sti.go:412] Using image name docker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a
I0601 13:43:14.596962       1 sti.go:416] No .sti/environment provided (no environment file found in application sources)
I0601 13:43:14.597202       1 sti.go:517] starting the source uploading ...
I0601 13:43:14.599922       1 docker.go:410] Image contains io.openshift.s2i.scripts-url set to 'image:///usr/libexec/s2i'
I0601 13:43:14.599968       1 docker.go:465] Base directory for STI scripts is '/usr/libexec/s2i'. Untarring destination is '/tmp'.
I0601 13:43:14.600001       1 docker.go:614] Creating container  using config: &amp;{Hostname: Domainname: User: Memory:0 MemorySwap:0 MemoryReservation:0 KernelMemory:0 CPUShares:0 CPUSet: AttachStdin:false AttachStdout:true AttachStderr:false PortSpecs:[] ExposedPorts:map[] StopSignal: Tty:false OpenStdin:true StdinOnce:true Env:[OPENSHIFT_BUILD_SOURCE=ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git OPENSHIFT_BUILD_NAME=songbase-4 OPENSHIFT_BUILD_NAMESPACE=podenv] Cmd:[/bin/sh -c tar -C /tmp -xf - &amp;&amp; /usr/libexec/s2i/assemble] DNS:[] Image:docker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a Volumes:map[] VolumeDriver: VolumesFrom: WorkingDir: MacAddress: Entrypoint:[] NetworkDisabled:false SecurityOpts:[] OnBuild:[] Mounts:[] Labels:map[]}, hostconfig: &amp;{Binds:[] CapAdd:[] CapDrop:[] GroupAdd:[] ContainerIDFile: LxcConf:[] Privileged:false PortBindings:map[] Links:[] PublishAllPorts:false DNS:[] DNSOptions:[] DNSSearch:[] ExtraHosts:[] VolumesFrom:[] NetworkMode:container:5143741f587c6a0c514df19418240accb41dedbc8e1c063a6e62d03487268081 IpcMode: PidMode: UTSMode: RestartPolicy:{Name: MaximumRetryCount:0} Devices:[] LogConfig:{Type: Config:map[]} ReadonlyRootfs:false SecurityOpt:[] CgroupParent: Memory:9223372036854775807 MemorySwap:9223372036854775807 MemorySwappiness:0 OOMKillDisable:false CPUShares:2 CPUSet: CPUSetCPUs: CPUSetMEMs: CPUQuota:-1 CPUPeriod:100000 BlkioWeight:0 Ulimits:[] VolumeDriver:}
I0601 13:43:14.876241       1 docker.go:621] Attaching to container
I0601 13:43:14.877370       1 docker.go:627] Starting container
I0601 13:43:15.059454       1 docker.go:548] Waiting for container
---> Copying application source ...
---> Installing dependencies ...
Downloading/unpacking PyMongo (from -r requirements.txt (line 1))
Running setup.py (path:/tmp/pip-build-9ZjcZ0/PyMongo/setup.py) egg_info for package PyMongo

Downloading/unpacking web.py (from -r requirements.txt (line 2))
Running setup.py (path:/tmp/pip-build-9ZjcZ0/web.py/setup.py) egg_info for package web.py

Installing collected packages: PyMongo, web.py
Running setup.py install for PyMongo
building 'bson._cbson' extension
gcc -pthread -fno-strict-aliasing -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -DNDEBUG -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -fPIC -Ibson -I/opt/rh/python27/root/usr/include/python2.7 -c bson/_cbsonmodule.c -o build/temp.linux-x86_64-2.7/bson/_cbsonmodule.o
gcc -pthread -fno-strict-aliasing -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -DNDEBUG -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -fPIC -Ibson -I/opt/rh/python27/root/usr/include/python2.7 -c bson/time64.c -o build/temp.linux-x86_64-2.7/bson/time64.o
gcc -pthread -fno-strict-aliasing -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -DNDEBUG -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -fPIC -Ibson -I/opt/rh/python27/root/usr/include/python2.7 -c bson/buffer.c -o build/temp.linux-x86_64-2.7/bson/buffer.o
gcc -pthread -fno-strict-aliasing -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -DNDEBUG -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -fPIC -Ibson -I/opt/rh/python27/root/usr/include/python2.7 -c bson/encoding_helpers.c -o build/temp.linux-x86_64-2.7/bson/encoding_helpers.o
gcc -pthread -shared -Wl,-z,relro build/temp.linux-x86_64-2.7/bson/_cbsonmodule.o build/temp.linux-x86_64-2.7/bson/time64.o build/temp.linux-x86_64-2.7/bson/buffer.o build/temp.linux-x86_64-2.7/bson/encoding_helpers.o -L/opt/rh/python27/root/usr/lib64 -lpython2.7 -o build/lib.linux-x86_64-2.7/bson/_cbson.so
building 'pymongo._cmessage' extension
gcc -pthread -fno-strict-aliasing -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -DNDEBUG -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -fPIC -Ibson -I/opt/rh/python27/root/usr/include/python2.7 -c pymongo/_cmessagemodule.c -o build/temp.linux-x86_64-2.7/pymongo/_cmessagemodule.o
gcc -pthread -fno-strict-aliasing -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -DNDEBUG -O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -D_GNU_SOURCE -fPIC -fwrapv -fPIC -Ibson -I/opt/rh/python27/root/usr/include/python2.7 -c bson/buffer.c -o build/temp.linux-x86_64-2.7/bson/buffer.o
gcc -pthread -shared -Wl,-z,relro build/temp.linux-x86_64-2.7/pymongo/_cmessagemodule.o build/temp.linux-x86_64-2.7/bson/buffer.o -L/opt/rh/python27/root/usr/lib64 -lpython2.7 -o build/lib.linux-x86_64-2.7/pymongo/_cmessage.so

Running setup.py install for web.py

Successfully installed PyMongo web.py
Cleaning up...
I0601 13:43:18.868300       1 docker.go:550] Container wait returns with 0 and &lt;nil&gt;
I0601 13:43:18.868352       1 docker.go:557] Container exited
I0601 13:43:18.868361       1 docker.go:649] Invoking postExecution function
I0601 13:43:18.868413       1 sti.go:269] No .sti/environment provided (no environment file found in application sources)
I0601 13:43:18.872406       1 docker.go:684] Committing container with dockerOpts: {Container:d0aecf75cbf133109e3deb97e58602c8fa52846da7f2fa741668e1d8c0da8d30 Repository:podenv/songbase-4 Tag:dddeb478 Message: Author: Run:0xc208654700}, config: {Hostname: Domainname: User:1001 Memory:0 MemorySwap:0 MemoryReservation:0 KernelMemory:0 CPUShares:0 CPUSet: AttachStdin:false AttachStdout:false AttachStderr:false PortSpecs:[] ExposedPorts:map[] StopSignal: Tty:false OpenStdin:false StdinOnce:false Env:[OPENSHIFT_BUILD_NAME=songbase-4 OPENSHIFT_BUILD_NAMESPACE=podenv OPENSHIFT_BUILD_SOURCE=ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git] Cmd:[/usr/libexec/s2i/run] DNS:[] Image: Volumes:map[] VolumeDriver: VolumesFrom: WorkingDir: MacAddress: Entrypoint:[] NetworkDisabled:false SecurityOpts:[] OnBuild:[] Mounts:[] Labels:map[io.k8s.description:Platform for building and running Python 2.7 applications io.k8s.display-name:podenv/songbase-4:dddeb478 license:GPLv2 io.openshift.build.image:docker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a io.s2i.scripts-url:image:///usr/libexec/s2i name:CentOS Base Image build-date:2015-12-23 io.openshift.tags:builder,python,python27,rh-python27 io.openshift.s2i.scripts-url:image:///usr/libexec/s2i io.openshift.build.commit.date:Wed Mar 23 10:05:43 2016 +0100 io.openshift.build.source-location:ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git io.openshift.builder-version:738d0f859cfd2a80bb11e48eeefb3a6eb1b3c4f3 io.openshift.build.commit.id:c09b957679827147c619127a55ac1ca35078d39e io.openshift.build.commit.ref:master io.openshift.build.commit.author:Michael Leimenmeier &lt;michael.leimenmeier@gfi.ihk.de&gt; io.openshift.builder-base-version:8d95148 io.openshift.expose-services:8080:http io.openshift.build.commit.message:name of mongodb resource changed to mongodemodb vendor:CentOS]}
I0601 13:43:23.281508       1 sti.go:314] Successfully built podenv/songbase-4:dddeb478
I0601 13:43:23.297248       1 cleanup.go:23] Removing temporary directory /tmp/s2i-build284983461
I0601 13:43:23.297294       1 fs.go:156] Removing directory '/tmp/s2i-build284983461'
I0601 13:43:23.783865       1 sti.go:246] Using provided push secret for pushing 172.30.25.80:5000/podenv/songbase:latest image
I0601 13:43:23.783926       1 sti.go:250] Pushing 172.30.25.80:5000/podenv/songbase:latest image ...
I0601 13:43:24.563258       1 sti.go:266] Successfully pushed 172.30.25.80:5000/podenv/songbase:latest</pre></code>
	  </p>
          <p>
	    oder direkt in einem Abwasch:
	    <code><pre><strong>15:04:24 leimm@189tuxlem001:~></strong> oc start-build bc/songbase --follow
songbase-5
I0601 13:45:37.369040       1 builder.go:57] Master version "v1.1.3", Builder versions "v1.1.3"
I0601 13:45:37.384766       1 builder.go:145] Running build with cgroup limits: api.CGroupLimits{MemoryLimitBytes:9223372036854775807, CPUShares:2, CPUPeriod:100000, CPUQuota:-1, MemorySwap:9223372036854775807}
I0601 13:45:37.388068       1 sti.go:190] The value of ALLOWED_UIDS is [1-]
I0601 13:45:37.392898       1 docker.go:290] Using locally available image "docker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a"
I0601 13:45:37.395641       1 sti.go:212] Creating a new S2I builder with build config: "Builder Name:\t\tPython 2.7\nBuilder Image:\t\tdocker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a\nBuilder Image Version:\t738d0f859cfd2a80bb11e48eeefb3a6eb1b3c4f3\nBuilder Base Version:\t8d95148\nSource:\t\t\tfile:///tmp/s2i-build234457033/upload/src\nOutput Image Tag:\tpodenv/songbase-5:fd921d63\nEnvironment:\t\tOPENSHIFT_BUILD_NAME=songbase-5,OPENSHIFT_BUILD_NAMESPACE=podenv,OPENSHIFT_BUILD_SOURCE=ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git\nIncremental Build:\tdisabled\nRemove Old Build:\tdisabled\nBuilder Pull Policy:\tif-not-present\nQuiet:\t\t\tdisabled\nLayered Build:\t\tdisabled\nWorkdir:\t\t/tmp/s2i-build234457033\nDocker NetworkMode:\tcontainer:df30b4b65c450bac1121680c7283d0df44bd0e67aeec3a662e04f4cc58d5e1b8\nDocker Endpoint:\tunix:///var/run/docker.sock\n"

[...]</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_Builds.png" alt="Build-&Uuml;bersicht mit der M&ouml;glichkeit einen neuen Build zu starten."/>
	  </p>
	  <p class="note">
	    In dieser &Uuml;bersicht sehen wir, dass Build #1 nach nur 3 Sekunden fehlschlug, was darauf hindeutet, dass wir auf ein privates
	    git Repository mit ssh zugreifen, aber noch keinen ssh key hinterlegt hatten (siehe <em>ssh Schl&uuml;ssel hinterlegen</em>).<br/>
	    An Build #2 und den folgenden erkennen wir ausserdem, dass der erste erfolgreiche Build l&auml;nger dauerte als die nachfolgenden, da
	    das Caching den Buildprozess ab #3 beschleunigt.
	  </p>
          <p>
	    <img class="table" src="images/GUI_Build_Log.png" alt="Log Ausgabe des letzten songbase Builds."/>
	  </p>


	  <h4>Route erzeugen um die Applikation nach aussen zur Verf&uuml;gung zu stellen</h4>
	  <p>
	    <code><pre><strong>15:35:21 leimm@189tuxlem001:~></strong> oc expose svc/songbase --hostname=songbase.argo.gfi.ihk.de
route "songbase" exposed</pre></code>
	  </p>

	  <h4>Anzahl der Pods von 1 auf 5 hochskalieren</h4>
	  <p>
	    <code><pre><strong>15:37:10 leimm@189tuxlem001:~></strong> oc scale dc/songbase --replicas=5
deploymentconfig "songbase" scaled</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_Overview_Songbase.png" alt="&Uuml;bersicht der vollst&auml;ndigen Applikation mit integrierter MongoDB"/>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_Overview_Songbase_dependencies.png" alt="Abh&auml;ngigkeiten der vollst&auml;ndigen Applikation mit integrierter MongoDB"/>
	  </p>

	  <h4>Environment Variablen der MongoDB Instanz auslesen und der Applikation mitteilen</h4>
	  <p>
	    Environment aus der DeploymentConfig der MongoDB auslesen:
	    <code><pre><strong>15:43:30 leimm@189tuxlem001:~></strong> oc env dc/mongodemodb --list
# deploymentconfigs mongodemodb, container mongodb
MONGODB_USER=user13L
MONGODB_PASSWORD=4odluk5m77SDVSjN
MONGODB_DATABASE=sampledb
MONGODB_ADMIN_PASSWORD=8PIUf7YE8WvQE7Mh</pre></code>
	  </p>
	  <p>
	    Variablen in die DeploymentConfig der Applikation injezieren:
	    <code><pre><strong>15:44:49 leimm@189tuxlem001:~></strong> for var in $(oc env dc/mongodemodb --list | grep -v ^#); do oc env dc/songbase $var; done
deploymentconfig "songbase" updated
deploymentconfig "songbase" updated
deploymentconfig "songbase" updated
deploymentconfig "songbase" updated</pre></code>
	  </p>
          <p>
	    Und noch einmal kontrollieren:
	    <code><pre><strong>15:45:54 leimm@189tuxlem001:~></strong> oc env dc/songbase --list
# deploymentconfigs songbase, container songbase
MONGODB_DATABASE=sampledb
MONGODB_PASSWORD=4odluk5m77SDVSjN
MONGODB_USER=user13L
PYTHONUNBUFFERED=0
MONGODB_ADMIN_PASSWORD=8PIUf7YE8WvQE7Mh</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_Environment.png" alt="Environment Variablen der MongoDB"/>
	  </p>
	  <p>
	    Im eigentlichen Programmcode (oder bei fertigen Applikationen in den Konfigurationsdateien) greift man dann auf diese Variablen zu um sich mit der Datenbank zu verbinden:
	    <code><pre>[...]
# read environment variables to collect information about the mongodb
mongohost = os.getenv("MONGODEMODB_SERVICE_HOST", "localhost")
mongoport = os.getenv("MONGODEMODB_SERVICE_PORT", 27017)
username  = os.getenv("MONGODB_USER")
password  = os.getenv("MONGODB_PASSWORD")
dbname    = os.getenv("MONGODB_DATABASE")
adminpwd  = os.getenv("MONGODB_ADMIN_PASSWORD")

### URI format: mongodb://[dbuser:dbpassword@]host:port/dbname
MONGODB_URI = 'mongodb://%s:%s@%s:%d/%s' % (username, password,
                                            mongohost, int(mongoport),
                                            dbname)
print ("Connecting to mongodb: %s ..." % MONGODB_URI)

client = pymongo.MongoClient(MONGODB_URI)
db     = client.get_default_database()

songs = db['songs']
[...]</pre></code>
	  </p>

	  <h4>Die fertige Applikation</h4>
	  <p>
	    <img class="table" src="images/songbase_screenshot.png" alt=""/>
	  </p>


	  <p><a href="#top">Back to top</a></p>



	  <a name="new-app-dockerfile"/>
	  <h3>Installation einer Applikation via Docker Build Strategie</h3>
          <p>
	    Bei dieser Methode legt man seine Quellen zusammen mit einem Dockerfile einfach in ein git Repository ab und erzeugt mit dem oc Kommando eine neue app.
	    Dabei zu beachten ist, dass ein Container in OpenShift immer unter einer zuf&auml;llig generierten UserID l&auml;uft und nicht wie im Docker Standard mit root-Rechten.
	  </p>

	  
	  <h4>&Uuml;bersicht &uuml;ber das git Repository</h4>
	  <p>
	    <code><pre><strong>08:35:51 leimm@189tuxlem001:podenv></strong> ls -R1
.:
Dockerfile
README.md
src

./src:
gowebenv

./src/gowebenv:
main.go</pre></code>
	    Der eigentliche Quellcode der Anwendung befindet sich im src/gowebenv Unterverzeichnis. Das f&uuml;r uns wichtige Dockerfile direkt im Hauptstamm.
	  </p>
	  
	  <h4>Das Dockerfile</h4>
	  <p>
	    <code><pre>FROM golang:latest

COPY src/gowebenv/. /go/src/app
WORKDIR /go/src/app

RUN go build -v
RUN go install -v

EXPOSE 8000

CMD ["app"]</pre></code>
	    Dies ist ein einfaches Beispiel, in dem zuerst der Quellcode kopiert, dann das Arbeitsverzeichnis entsprechend gesetzt und anschliessend die Applikation
	    kompiliert und installiert wird. Damit ist der Build Anteil des Dockerfiles abgeschlossen; die letzten beiden Zeilen sind f&uuml; die Laufzeit bestimmt.
	    Und zwar teilen wir dem OpenShift mit, dass unsere Applikation auf Port 8000 lauscht und OpenShift einen entsprechenden Service daf&uuml;r einrichten soll und 
	    zu guter Letzt welches Kommando er in dem Container ausf&uuml;hren soll.
	  </p>
	  
	  <h4>Applikation erstellen</h4>
	  <p>
	    <code><pre><strong>10:34:22 leimm@189tuxlem001:podenv></strong> oc new-app ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/podenv.git --strategy=docker
The authenticity of host '[bitbucket.backend.gfi.ihk.de]:7999 ([10.189.91.62]:7999)' can't be established.
RSA key fingerprint is 85:2b:a6:e3:94:2c:c9:79:9b:6f:46:19:6c:89:e0:92.
Are you sure you want to continue connecting (yes/no)? yes
--> Found Docker image a944ae6 (13 days old) from Docker Hub for "golang:latest"

    * An image stream will be created as "golang:latest" that will track the source image
    * A Docker build using source code from ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/podenv.git will be created
      * The resulting image will be pushed to image stream "podenv:latest"
      * Every time "golang:latest" changes a new build will be triggered
    * This image will be deployed in deployment config "podenv"
    * Port 8000 will be load balanced by service "podenv"
      * Other containers can access this service through the hostname "podenv"
    * WARNING: Image "podenv" runs as the 'root' user which may not be permitted by your cluster administrator

--> Creating resources with label app=podenv ...
    imagestream "golang" created
    imagestream "podenv" created
    buildconfig "podenv" created
    deploymentconfig "podenv" created
    service "podenv" created
--> Success
    Build scheduled for "podenv", use 'oc logs' to track its progress.
    Run 'oc status' to view your app.</pre></code>
            Der --strategy=docker Schalter dient dazu die automatische Erkennung des Quelltexttyps zu unterbinden und in jedem Falle einen Docker-Build durchzuf&uuml;hren,
            da sonst der OpenShift ein zum Quellcode passendes S2I Builder Image vorschl&auml;gt wenn er z.B. ein Python Skript im repository vorfindet.
          </p>

          <h4>Build Vorgang anschauen</h4>
          <p>
            <code><pre><strong>10:36:44 leimm@189tuxlem001:podenv></strong> oc logs bc/podenv --follow
podenv-1
I0607 08:39:39.945906       1 builder.go:57] Master version "v1.2.0", Builder version "v1.2.0"
I0607 08:39:39.963958       1 builder.go:145] Running build with cgroup limits: api.CGroupLimits{MemoryLimitBytes:92233720368547, CPUShares:2, CPUPeriod:100000, CPUQuota:-1, MemorySwap:92233720368547}
I0607 08:39:39.964699       1 source.go:197] Downloading "ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/podenv.git" ...
I0607 08:39:40.175976       1 source.go:208] Cloning source from ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/podenv.git
Step 1 : FROM golang@sha256:a944ae6f2d2259e4b9fcdf6ddcacce91231d7c3f1b950c9a33774a963fdc7eae
Trying to pull repository docker.io/library/golang ... Pulling from library/golang
Pulling fs layer
Pulling fs layer
Pulling fs layer
Pulling fs layer
Pulling fs layer
Pulling fs layer
Pulling fs layer
Pulling fs layer
Pulling fs layer
Pulling fs layer
Downloading [==================================================>]     32 B/32 B
Verifying Checksum
Download complete
Downloading [==================================================>]     32 B/32 B
Verifying Checksum
Download complete
Downloading [==================================================>]     32 B/32 B
Verifying Checksum
Download complete
Downloading [==================================================>] 1.356 kB/1.356 kB
Verifying Checksum
Download complete
Downloading [==================================================>]    123 B/123 B
Downloading [=================================================> ] 56.77 MB/56.9 MB
Downloading [==================================================>]  56.9 MB/56.9 MB
Verifying Checksum
Download complete
Downloading [======================>                            ] 37.85 MB/84.85 MB
Downloading [======================>                            ] 38.39 MB/84.85 MB
Downloading [======================>                            ] 38.93 MB/84.85 MB
Extracting [>                                                  ] 557.1 kB/56.9 MB
Downloading [=================================================> ] 84.34 MB/84.85 MB
Downloading [==================================================>] 84.85 MB/84.85 MB
Verifying Checksum
Download complete
Extracting [>                                                  ] 557.1 kB/84.85 MB
Extracting [>                                                  ] 1.114 MB/84.85 MB
Extracting [>                                                  ] 1.671 MB/84.85 MB
Extracting [=>                                                 ] 2.228 MB/84.85 MB
Extracting [=>                                                 ] 2.785 MB/84.85 MB
Extracting [=>                                                 ] 3.342 MB/84.85 MB
Extracting [==>                                                ] 3.899 MB/84.85 MB
Extracting [==>                                                ] 4.456 MB/84.85 MB
Extracting [==>                                                ] 5.014 MB/84.85 MB
Extracting [===>                                               ] 5.571 MB/84.85 MB
Extracting [===>                                               ] 6.128 MB/84.85 MB
Extracting [===>                                               ] 6.685 MB/84.85 MB
Extracting [====>                                              ] 7.242 MB/84.85 MB
Extracting [====>                                              ] 7.799 MB/84.85 MB
Extracting [====>                                              ] 8.356 MB/84.85 MB
Extracting [=================================================> ] 84.12 MB/84.85 MB
Extracting [=================================================> ] 84.67 MB/84.85 MB
Extracting [==================================================>] 84.85 MB/84.85 MB
Extracting [==================================================>] 84.85 MB/84.85 MB
Pull complete
Extracting [==================================================>]     32 B/32 B
Extracting [==================================================>]     32 B/32 B
Extracting [==================================================>]     32 B/32 B
Pull complete
Extracting [==================================================>]     32 B/32 B
Extracting [==================================================>]     32 B/32 B
Extracting [==================================================>]     32 B/32 B
Pull complete
Extracting [==================================================>]    123 B/123 B
Extracting [==================================================>]    123 B/123 B
Extracting [==================================================>]    123 B/123 B
Pull complete
Extracting [==================================================>]     32 B/32 B
Extracting [==================================================>]     32 B/32 B
Extracting [==================================================>]     32 B/32 B
Pull complete
Extracting [==================================================>] 1.356 kB/1.356 kB
Extracting [==================================================>] 1.356 kB/1.356 kB
Extracting [==================================================>] 1.356 kB/1.356 kB
Pull complete
Digest: sha256:a944ae6f2d2259e4b9fcdf6ddcacce91231d7c3f1b950c9a33774a963fdc7eae
Status: Downloaded newer image for docker.io/golang@sha256:a944ae6f2d2259e4b9fcdf6ddcacce91231d7c3f1b950c9a33774a963fdc7eae
 ---> 024309f28934
Step 2 : COPY src/gowebenv/. /go/src/app
 ---> e64bd0a8edc5
Removing intermediate container 2ba876057f0e
Step 3 : WORKDIR /go/src/app
 ---> Running in 9f1992aa8fca
 ---> f695739fdbc9
Removing intermediate container 9f1992aa8fca
Step 4 : RUN go build -v
 ---> Running in 893aaa3b7ce4
app
 ---> 59e43e9e0db8
Removing intermediate container 893aaa3b7ce4
Step 5 : RUN go install -v
 ---> Running in 8cb2aa6203f5
app
 ---> a20962c4d4ff
Removing intermediate container 8cb2aa6203f5
Step 6 : EXPOSE 8000
 ---> Running in 7b600eed1981
 ---> 7b38469d7d25
Removing intermediate container 7b600eed1981
Step 7 : CMD app
 ---> Running in 93f2ab68a2af
 ---> 465fefc08cbb
Removing intermediate container 93f2ab68a2af
Step 8 : ENV "OPENSHIFT_BUILD_NAME" "podenv-1" "OPENSHIFT_BUILD_NAMESPACE" "podenv" "OPENSHIFT_BUILD_SOURCE" "ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/podenv.git" "OPENSHIFT_BUILD_COMMIT" "a093f7041ed99d9b3871fdfc47dc81f4c57faa12"
 ---> Running in e9ef11386aeb
 ---> ca431a0b2e74
Removing intermediate container e9ef11386aeb
Step 9 : LABEL "io.openshift.build.commit.author" "Michael Leimenmeier \u003cmichael.leimenmeier@gfi.ihk.de\u003e" "io.openshift.build.commit.date" "Thu Feb 25 11:15:47 2016 +0100" "io.openshift.build.commit.id" "a093f7041ed99d9b3871fdfc47dc81f4c57faa12" "io.openshift.build.commit.ref" "master" "io.openshift.build.commit.message" "testbug included" "io.openshift.build.source-location" "ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/podenv.git"
 ---> Running in 33c60d1ac517
 ---> c7bc4ea9674e
Removing intermediate container 33c60d1ac517
Successfully built c7bc4ea9674e
I0607 08:40:44.352348       1 docker.go:118] Pushing image 172.30.25.80:5000/podenv/podenv:latest ...
I0607 08:42:13.628008       1 docker.go:122] Push successful</pre></code>
            Die Zeilen in denen der Docker Daemon das image herunterl&auml;dt und extrahiert wurden gek&uuml;rzt um die Lesbarkeit zu erh&ouml;hen. 
	  </p>

	  <h4>Route erzeugen um die Applikation nach aussen zur Verf&uuml;gung zu stellen</h4>
	  <p>
	    <code><pre><strong>15:35:21 leimm@189tuxlem001:~></strong> oc expose svc/podenv --hostname=podenv.argo.gfi.ihk.de
route "podenv" exposed</pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/GUI_CreateRoute.png" alt="Anlegen einer Route mit der WebGUI"/>
	  </p>
          <p class="note">
	    Unter dem Punkt "Show options for secured routes" k&ouml;nnen bei Bedarf noch SSL/TLS-Zertifikate hinterlegt und eine Terminierung der Verbindung festgelegt werden.
	  </p>

	  <h4>Projekt&uuml;bersicht</h4>
	  <p>
	    <img class="table" src="images/GUI_Podenv_Overview.png" alt="&Uuml;bersicht &uuml;ber das podenv Projekt"/>
	  </p> 
          <p class="note">
	    Hier sehen wir das Projekt mit der podenv app und k&ouml;nnen anhand des blauen Kreises den Status (falls Probleme auftreten wird dieser gelb) und die Anzahl
	    der aktuell laufenden Pods ermitteln (und mit Hilfe der Pfeiltasten auch bequem hoch und runter skalieren). <br/>
	    Ausserdem sehen wir die definierte Route, unter der unser Webservice nun von ausserhalb zu erreichen ist: podenv.gfi.ihk.de.
	  </p>
	  <p>
	    <img class="table" src="images/podenv_screenshot.png" alt="Unsere Webapplikation"/>
	  </p>

	  <p><a href="#top">Back to top</a></p>
	  <div class="page-break"></div>


	  <a name="ssh-keys"/>
	  <h2>ssh Schl&uuml;ssel hinterlegen</h2>
	  <p>Ist das Repository aus dem man seine Applikation bezieht nicht &ouml;ffentlich empfiehlt es sich einen ssh Schl&uuml;ssel zu erzeugen und diesen dann sowohl in
	    den Benutzereinstellungen in der Repository-Verwaltung (bitbucket, github, gitlab, o.&auml;.) einzuf&uuml;gen als auch in der BuildConfig des OpenShift Projektes
	    zu hinterlegen, da es dem Build Prozess auf dem OpenShift Cluster sonst nicht m&ouml;glich ist sich gegen das Repository zu authentifizieren.</p>
	  <ol>
	    <li>Zu Beginn erzeugen wir einen ssh Schl&uuml;ssel, der <strong>nicht</strong> durch eine Passphrase abgesichert sein darf, da ein automatisierter Build sonst statt des 
	      Repository Kennwortes nun die Eingabe der Passphrase erfordern w&uuml;rde und wir nichts gewonnen h&auml;tten.</li>
	    <li>Den erzeugten Public Key hinterlegen wir nun im Benutzerprofil des Bitbucket.</li>
	    <li>Aus dem Private Key erzeugen wir nun im OpenShift ein Objekt des Typs <em>secret</em></li>
	    <li>und erlauben dem f&uuml;r den Build zust&auml;ndigen OpenShift Systemaccount den Zugriff auf selbiges.</li>
	    <li>Zu guter Letzt muss das secret noch in der BuildConfig der jeweiligen Applikation hinterlegt werden, in dem wir der BuildConfig zwei Zeilen hinzuf&uuml;gen.</li>
	  </ol>
	  
	  <h4>SSH Schl&uuml;ssel generieren</h4>
	  <p>
	    <code><pre><b>10:46:54 mleimenmeier@h2366850:sshkey></b> ssh-keygen -f git
Generating public/private rsa key pair.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in git.
Your public key has been saved in git.pub.
The key fingerprint is:
bb:1d:f8:51:02:03:92:28:8b:f3:59:7d:15:f4:cc:bf mleimenmeier@h2366850.189tuxprinzip.de
The key's randomart image is:
+--[ RSA 2048]----+
|   ....  .o.     |
|. . .. .  .+     |
|.o   .  o.  +    |
|+   . . .o   .   |
| o o   .S . . .  |
|  o      o o   . |
|        o o   E  |
|         + o     |
|        . o      |
+-----------------+

<strong>10:47:18 mleimenmeier@h2366850:sshkey></strong> ls -l
total 8
-rw-------. 1 mleimenmeier mleimenmeier 1679 Jun  1 10:47 git
-rw-r--r--. 1 mleimenmeier mleimenmeier  420 Jun  1 10:47 git.pub

<strong>10:47:30 mleimenmeier@h2366850:sshkey></strong> file *
git:     PEM RSA private key
git.pub: OpenSSH RSA public key

<strong>10:47:49 mleimenmeier@h2366850:sshkey></strong> cat git.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDJcTtfw6e+6LzXGqwtQ71xJoOHuHpAh3IIoiwNxbsCPaDf26LtT9l3j16Iu+8ItiiF2E6jXNQqiiVONnV44v/OhydqNCXOsXY9IbLVB+A3bsoZp6rvphIIDiFQif6tGA/xaEeDmN9HyAZnCX4OEDnMz0MQxukwNEgJy4+IM1nkSEKKD1fB6+/5HiauiXLjS513MMS3PYLKkeEP7MtzM5YAB0xvPA/E/FbG/A8KYTOeLA/fRAitipAHeKzir11xA5iquRbTNdV+USsBp5hqWP4HyerHPMjamtEjIdfI36c4rmNzy7zdSaYJx5U744xjev8mB9QTUxnJNBThfjJWl22n mleimenmeier@h2366850.189tuxprinzip.de</pre></code>
	  </p>
	  

	  <h4>SSH Schl&uuml;ssel im Benutzerprofile des Bitbucket hinterlegen</h4>

          <p>
	    <img class="table" src="images/GUI_Bitbucket_Key.png" alt="SSH Schl&uuml;ssel im Bitbucket Benutzerprofil hinterlegen."/>
	  </p>

	  <h4>OpenShift secret aus dem private key erstellen</h4>
	  <p>
	    <code><pre><strong>10:55:19 mleimenmeier@h2366850:sshkey></strong> oc secrets new-sshauth sshsecret --ssh-privatekey=git
secret/sshsecret</pre></code>
	  </p>


	  <h4>Dem Builder Systemaccount Zugriff auf das secret gew&auml;hren</h4>
          <p>
	    <code><pre><strong>10:55:21 mleimenmeier@h2366850:sshkey></strong> oc secrets add serviceaccount/builder secrets/sshsecret</pre></code>
	  </p>	  


	  <h4>Das secret in der BuildConfig hinterlegen (die beiden gr&uuml;n markierten Zeilen einf&uuml;gen)</h4>
	  <p>
	    <code><pre><strong>10:55:44 mleimenmeier@h2366850:sshkey></strong> oc edit bc/songbase 

File Edit Options Buffers Tools Help

# Please edit the object below. Lines beginning with a '#' will be ignored,
# and an empty file will abort the edit. If an error occurs while saving this file will be
# reopened with the relevant failures.
#
apiVersion: v1
kind: BuildConfig
metadata:
  annotations:
    openshift.io/generated-by: OpenShiftNewApp
  creationTimestamp: 2016-03-23T08:48:05Z
  labels:
    app: songbase
  name: songbase
  namespace: mongodemo
  resourceVersion: "1679520"
  selfLink: /oapi/v1/namespaces/mongodemo/buildconfigs/songbase
  uid: f5be821e-f0d3-11e5-ab83-001a4a683439
spec:
  output:
    to:
      kind: ImageStreamTag
      name: songbase:latest
  postCommit: {}
  resources: {}
  source:
    git:
      ref: release
      uri: ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git
    secrets: []
<font color="green">    sourceSecret:
      name: sshsecret</font>
    type: Git
  strategy:
    sourceStrategy:
      from:
        kind: ImageStreamTag
        name: python:2.7
        namespace: openshift
    type: Source
  triggers:
  - github:
      secret: IReaRK75rWbI6oWtED5u
    type: GitHub
  - generic:
      secret: xiOpJzUf8oLK5QzgUOMO
    type: Generic
  - type: ConfigChange
  - imageChange:
      lastTriggeredImageID: docker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a
    type: ImageChange
status:
  lastVersion: 4

--- snap ---</pre></code>
	  </p>


	  <p><a href="#top">Back to top</a></p>
	  <div class="page-break"></div>

	  <a name="webhooks"/>
	  <h2>Webhooks</h2>
	  <h3>Webhooks setzen um automatisierte Builds bei &Auml;nderungen am Quellcode zu erm&ouml;glichen</h3>
	  <h4>Webhook aus Buildconfig ermitteln</h4>
	  <p>
	    <code><pre><strong>10:41:38 leimm@189tuxlem001:mongodemo></strong> oc get bc
NAME       TYPE      FROM          LATEST
songbase   Source    Git@release   7

<strong>10:46:43 leimm@189tuxlem001:mongodemo></strong> oc describe bc/songbase
Name:                   songbase
Created:                11 weeks ago
Labels:                 app=songbase
Annotations:            openshift.io/generated-by=OpenShiftNewApp
Latest Version:         7
Strategy:               Source
URL:                    ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git
Ref:                    release
Source Secret:          sshsecret
From Image:             ImageStreamTag openshift/python:2.7
Output to:              ImageStreamTag songbase:latest
Triggered by:           Config, ImageChange
Webhook GitHub:         https://openshift-nonprod.gfi.ihk.de:8443/oapi/v1/namespaces/mongodemo/buildconfigs/songbase/webhooks/IReaRK75rWbI6oWtED5u/github
<font color="green">Webhook Generic:        https://openshift-nonprod.gfi.ihk.de:8443/oapi/v1/namespaces/mongodemo/buildconfigs/songbase/webhooks/xiOpJzUf8oLK5QzgUOMO/generic</font>

Build           Status          Duration        Creation Time
songbase-7      complete        11s             2016-06-07 10:12:12 +0200 CEST
songbase-6      complete        25s             2016-06-01 15:10:44 +0200 CEST
songbase-5      complete        13s             2016-06-01 15:09:39 +0200 CEST
songbase-4      complete        11s             2016-03-24 08:18:32 +0100 CET
songbase-3      complete        12s             2016-03-23 10:06:27 +0100 CET
songbase-2      complete        34s             2016-03-23 09:50:24 +0100 CET
songbase-1      failed          3s              2016-03-23 09:48:05 +0100 CET
</pre></code>
	  </p>

	  <h4>Webhook in den Projekteinstellungen im git Repository hinterlegen</h4>
	  <p>
	    <img class="table" src="images/Bitbucket_Webhook.png" alt="Webhook im Bitbucket hinterlegen"/>
	  </p>
	  <p class="note">
	    In den Repository Einstellungen w&auml;hlen wir Workflow->Hooks aus und dort das "Http Request Post Receive Hook" Plugin in dem wir unsere Webhook aus der
	    OpenShift BuildConfig mit der POST Methode einf&uuml;gen und die Benachrichtigungen zum rebuild nach bestimmten Kriterien via Regular Expression beschr&auml;nken. 
	    Im obigen Beispiel wird also bei jeder &Auml;nderung die im release Zweig des git Repositories eingecheckt wird eine Nachricht an den OpenShift Cluster geschickt
	    und dieser aufgefordert einen neuen Build anzustossen (s.u.).
	  </p>


	  <h4>Kontrollieren ob der Webhook funktioniert</h4>
	  <p>
	    <code><pre>
<strong>10:46:53 leimm@189tuxlem001:mongodemo></strong> git checkout release
Switched to branch 'release'
Your branch is up-to-date with 'origin/release'.

<strong>11:02:32 leimm@189tuxlem001:mongodemo></strong> git merge master
Updating c09b957..2a9b779
Fast-forward
 app.py | 11 ++++++++---
 1 file changed, 8 insertions(+), 3 deletions(-)

<strong>11:02:43 leimm@189tuxlem001:mongodemo></strong> git commit -m "neurotic fish released"
On branch release
Your branch is ahead of 'origin/release' by 1 commit.
  (use "git push" to publish your local commits)
nothing to commit, working directory clean

<strong>11:04:36 leimm@189tuxlem001:mongodemo></strong> oc get builds --watch &amp;
[1] 7196

NAME         TYPE      FROM          STATUS     STARTED        DURATION
songbase-1   Source    Git@release   Failed     11 weeks ago   3s
songbase-2   Source    Git@dac2f74   Complete   11 weeks ago   34s
songbase-3   Source    Git@c09b957   Complete   11 weeks ago   12s
songbase-4   Source    Git@c09b957   Complete   11 weeks ago   11s
songbase-5   Source    Git@c09b957   Complete   8 days ago     13s
songbase-6   Source    Git@c09b957   Complete   8 days ago     25s
songbase-7   Source    Git@c09b957   Complete   3 days ago     11s


<strong>11:04:39 leimm@189tuxlem001:mongodemo></strong> git push
Total 0 (delta 0), reused 0 (delta 0)
remote:
remote: Pull Request erstellen fÃ¼r release:
remote:   https://bitbucket.gfi.ihk.de/projects/189tux/repos/mongodemo/compare/commits?sourceBranch=refs/heads/release
remote:
To ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git
   c09b957..2a9b779  release -> release

<strong>11:04:44 leimm@189tuxlem001:mongodemo></strong> 
NAME         TYPE      FROM          STATUS    STARTED   DURATION
songbase-8   Source    Git@release   New
songbase-8   Source    Git@release   Pending
songbase-8   Source    Git@release   Running   Less than a second ago
songbase-8   Source    Git@2a9b779   Running   1 seconds ago   1s
songbase-8   Source    Git@2a9b779   Complete   11 seconds ago   11s

<strong>11:06:45 leimm@189tuxlem001:mongodemo></strong> oc describe build songbase-8
Name:                   songbase-8
Created:                2 minutes ago
Labels:                 app=songbase,buildconfig=songbase,openshift.io/build-config.name=songbase
Annotations:            openshift.io/build.number=8
                        openshift.io/build.pod-name=songbase-8-build
Build Config:           songbase
Started:                2016-06-10 11:04:46 +0200 CEST
Finished:               2016-06-10 11:04:57 +0200 CEST
Duration:               11s
Build Pod:              songbase-8-build
Strategy:               Source
URL:                    ssh://git@bitbucket.backend.gfi.ihk.de:7999/189tux/mongodemo.git
Ref:                    release
Source Secret:          sshsecret
Commit:                 2a9b77903d2c52de06b556dd82379a2501306e43
Author:                 Michael Leimenmeier
Committer:              Michael Leimenmeier
Message:                Neurotic Fish added to default database
From Image:             DockerImage docker.io/centos/python-27-centos7@sha256:1ad8f282fd20d83c393004f76af39d2b6e8daff9034810e78e4c48219f10085a
Output to:              ImageStreamTag songbase:latest
Push Secret:            builder-dockercfg-shvzk
Git Commit:             2a9b77903d2c52de06b556dd82379a2501306e43
Revision Author:        Michael Leimenmeier &lt;michael.leimenmeier@gfi.ihk.de&gt;
Revision Committer:     Michael Leimenmeier &lt;michael.leimenmeier@gfi.ihk.de&gt;
Revision Message:       Neurotic Fish added to default database
Status:                 Complete
Events:
  FirstSeen     LastSeen        Count   From                                    SubobjectPath                   Type            Reason          Message
  ---------     --------        -----   ----                                    -------------                   --------        ------          -------
  2m            2m              1       {default-scheduler }                                                    Normal          Scheduled       Successfully assigned songbase-8-build to 189tuxosn301.gfi.ihk.de
  2m            2m              1       {kubelet 189tuxosn301.gfi.ihk.de}       spec.containers{sti-build}      Normal          Pulled          Container image "openshift/origin-sti-builder:v1.2.0" already present on machine
  2m            2m              1       {kubelet 189tuxosn301.gfi.ihk.de}       spec.containers{sti-build}      Normal          Created         Created container with docker id e57e53cc0a80
  2m            2m              1       {kubelet 189tuxosn301.gfi.ihk.de}       spec.containers{sti-build}      Normal          Started         Started container with docker id e57e53cc0a80 </pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/songbase_neurotic_screenshot.png" alt="Unsere neue Version der Applikation"/>
	  </p>


	  <p><a href="#top">Back to top</a></p>
	  <div class="page-break"></div>


	  
         </div> <!-- OpenShift -->
	
	  
      </div> <!-- maincontents -->

      <div id="footer">
	&copy; 2016, Michael Leimenmeier
	<br>
	All Rights reserved.
      </div> <!-- footer -->

    </div> <!-- contents -->
  </body>
</html>


<!--
	  <h4></h4>
	  <p>
	    <code><pre></pre></code>
	  </p>
	  <p>
	    <img class="table" src="images/" alt=""/>
	  </p>
-->
